<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Xác nhận tạo giải đấu</title>
    <link rel="stylesheet" href="../assets/styles/base.css">
    <link rel="stylesheet" href="../assets/styles/components.css">
    <link rel="stylesheet" href="../assets/styles/layout.css">
    <link rel="stylesheet" href="../assets/styles/create-tournament.css">
    <style>
        .confirmation-container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 2rem;
        }

        .step-indicator {
            display: flex;
            justify-content: center;
            margin-bottom: 3rem;
        }

        .step {
            display: flex;
            align-items: center;
            margin: 0 1rem;
        }

        .step-number {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 0.5rem;
        }

        .step.completed .step-number {
            background: #28a745;
            color: white;
        }

        .step.active .step-number {
            background: #667eea;
            color: white;
        }

        .tournament-summary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem;
            border-radius: 12px;
            margin-bottom: 2rem;
        }

        .tournament-title {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 1rem;
        }

        .tournament-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .detail-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 1rem;
            border-radius: 8px;
        }

        .detail-label {
            font-size: 0.9rem;
            opacity: 0.8;
            margin-bottom: 0.25rem;
        }

        .detail-value {
            font-weight: 600;
            font-size: 1.1rem;
        }

        .section-title {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: #2d3748;
        }

        .teams-summary {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .teams-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 1rem;
        }

        .team-summary-card {
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 1rem;
            background: #f7fafc;
        }

        .team-header {
            display: flex;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .team-logo-small {
            width: 40px;
            height: 40px;
            border-radius: 6px;
            object-fit: cover;
            margin-right: 0.75rem;
        }

        .team-name {
            font-weight: 600;
            color: #2d3748;
        }

        .team-region {
            color: #718096;
            font-size: 0.9rem;
        }

        .additional-settings {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .setting-group {
            margin-bottom: 1.5rem;
        }

        .setting-group:last-child {
            margin-bottom: 0;
        }

        .setting-label {
            display: block;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 0.5rem;
        }

        .setting-input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            font-size: 1rem;
        }

        .setting-textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            font-size: 1rem;
            min-height: 100px;
            resize: vertical;
        }

        .date-inputs {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .form-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
            margin-top: 2rem;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-success {
            background: #28a745;
            color: white;
            font-size: 1.1rem;
            padding: 1rem 2rem;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            display: none;
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            display: none;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 2rem;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f4f6;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- Header Navigation -->
    <header class="main-header">
        <div class="header-container">
            <div class="header-left">
                <div class="nav-item" onclick="window.location.href='organizer-dashboard.html'">
                    <svg class="nav-icon" width="40" height="40" viewBox="0 0 40 40" fill="none">
                        <path d="M15 36.6667V20H25V36.6667M5 15L20 3.33334L35 15V33.3333C35 34.2174 34.6488 35.0652 34.0237 35.6904C33.3986 36.3155 32.5507 36.6667 31.6667 36.6667H8.33333C7.44928 36.6667 6.60143 36.3155 5.97631 35.6904C5.35119 35.0652 5 34.2174 5 33.3333V15Z" stroke="#F5F5F5" stroke-width="4" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    <span class="nav-text">Trang chủ</span>
                </div>
            </div>
            <div class="header-center">
                <h1 style="color: white; margin: 0;">Xác nhận tạo giải đấu</h1>
            </div>
            <div class="header-right">
                <div class="user-avatar">
                    <img src="https://cdn.builder.io/api/v1/image/assets/TEMP/2791d338714d3870b4bb42ac5a5390446faac948?width=80" alt="User Avatar" class="avatar-image" />
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-content">
        <div class="confirmation-container">
            <!-- Step Indicator -->
            <div class="step-indicator">
                <div class="step completed">
                    <div class="step-number">1</div>
                    <span>Thông tin cơ bản</span>
                </div>
                <div class="step completed">
                    <div class="step-number">2</div>
                    <span>Chọn đội tham gia</span>
                </div>
                <div class="step active">
                    <div class="step-number">3</div>
                    <span>Xác nhận</span>
                </div>
            </div>

            <!-- Messages -->
            <div id="successMessage" class="success-message"></div>
            <div id="errorMessage" class="error-message"></div>
            <div id="loadingMessage" class="loading">
                <div class="loading-spinner"></div>
                <p>Đang tạo giải đấu...</p>
            </div>

            <!-- Tournament Summary -->
            <div class="tournament-summary">
                <div class="tournament-title" id="tournamentTitle">Tên giải đấu</div>
                <div class="tournament-details">
                    <div class="detail-item">
                        <div class="detail-label">Game</div>
                        <div class="detail-value" id="gameName">-</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Số người chơi tối đa</div>
                        <div class="detail-value" id="playerCount">-</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Số đội tham gia</div>
                        <div class="detail-value" id="teamCount">-</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Định dạng</div>
                        <div class="detail-value" id="tournamentFormat">Loại trực tiếp</div>
                    </div>
                </div>
            </div>

            <!-- Teams Summary -->
            <div class="teams-summary">
                <h2 class="section-title">Đội tham gia</h2>
                <div class="teams-grid" id="teamsGrid">
                    <!-- Teams will be populated here -->
                </div>
            </div>

            <!-- Additional Settings -->
            <div class="additional-settings">
                <h2 class="section-title">Thiết lập bổ sung</h2>
                
                <div class="setting-group">
                    <label class="setting-label" for="description">Mô tả giải đấu:</label>
                    <textarea id="description" class="setting-textarea" placeholder="Nhập mô tả cho giải đấu của bạn..."></textarea>
                </div>

                <div class="date-inputs">
                    <div class="setting-group">
                        <label class="setting-label" for="startDate">Ngày bắt đầu:</label>
                        <input type="datetime-local" id="startDate" class="setting-input">
                    </div>
                    <div class="setting-group">
                        <label class="setting-label" for="endDate">Ngày kết thúc:</label>
                        <input type="datetime-local" id="endDate" class="setting-input">
                    </div>
                </div>

                <div class="setting-group">
                    <label class="setting-label" for="avatarUrl">URL ảnh đại diện giải đấu:</label>
                    <input type="url" id="avatarUrl" class="setting-input" placeholder="https://example.com/tournament-logo.jpg">
                </div>
            </div>

            <!-- Form Actions -->
            <div class="form-actions">
                <a href="create-tournament-2.html" class="btn btn-secondary">
                    ← Quay lại
                </a>
                <button id="createTournamentBtn" class="btn btn-success">
                    🏆 Tạo giải đấu
                </button>
            </div>
        </div>
    </main>

    <script src="../frontend/js/api.js"></script>
    <script>
        let tournamentData = {};

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            loadTournamentData();
            initializeForm();
            setDefaultDates();
        });

        function loadTournamentData() {
            const savedData = localStorage.getItem('tournamentCreationData');
            if (savedData) {
                tournamentData = JSON.parse(savedData);
                displayTournamentSummary();
                displaySelectedTeams();
            } else {
                showError('Không tìm thấy thông tin giải đấu. Vui lòng quay lại bước 1.');
                document.getElementById('createTournamentBtn').disabled = true;
            }
        }

        function displayTournamentSummary() {
            document.getElementById('tournamentTitle').textContent = tournamentData.tournamentName || 'Tên giải đấu';
            document.getElementById('gameName').textContent = tournamentData.gameName || '-';
            document.getElementById('playerCount').textContent = tournamentData.playerCount || '-';
            document.getElementById('teamCount').textContent = (tournamentData.selectedTeams?.length || 0);

            // Display tournament format
            const formatNames = {
                'single-elimination': 'Đấu loại trực tiếp',
                'double-elimination': 'Vòng tròn kép',
                'group-stage': 'Đấu tổ hợp'
            };
            document.getElementById('tournamentFormat').textContent = formatNames[tournamentData.format] || 'Đấu loại trực tiếp';
        }

        function displaySelectedTeams() {
            const teamsGrid = document.getElementById('teamsGrid');
            
            if (!tournamentData.selectedTeams || tournamentData.selectedTeams.length === 0) {
                teamsGrid.innerHTML = '<p>Không có đội nào được chọn.</p>';
                return;
            }

            const teamsHTML = tournamentData.selectedTeams.map(team => `
                <div class="team-summary-card">
                    <div class="team-header">
                        <img src="${team.logoUrl}" alt="${team.name}" class="team-logo-small">
                        <div>
                            <div class="team-name">${team.name}</div>
                            <div class="team-region">${team.region || 'Không rõ'}</div>
                        </div>
                    </div>
                </div>
            `).join('');

            teamsGrid.innerHTML = teamsHTML;
        }

        function setDefaultDates() {
            const now = new Date();
            const tomorrow = new Date(now);
            tomorrow.setDate(tomorrow.getDate() + 1);
            
            const nextWeek = new Date(now);
            nextWeek.setDate(nextWeek.getDate() + 7);

            document.getElementById('startDate').value = formatDateTimeLocal(tomorrow);
            document.getElementById('endDate').value = formatDateTimeLocal(nextWeek);
        }

        function formatDateTimeLocal(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            
            return `${year}-${month}-${day}T${hours}:${minutes}`;
        }

        function initializeForm() {
            document.getElementById('createTournamentBtn').addEventListener('click', createTournament);
        }

        async function createTournament() {
            if (!validateForm()) {
                return;
            }

            try {
                showLoading(true);

                // Import the hybrid API
                const { apiCall } = await import('./js/hybrid-api.js');

                // Step 1: Create the tournament
                const tournamentPayload = {
                    name: tournamentData.tournamentName,
                    gameName: tournamentData.gameName,
                    description: document.getElementById('description').value.trim(),
                    maxPlayers: parseInt(tournamentData.playerCount),
                    format: tournamentData.format || 'single-elimination', // Use selected format
                    startDate: document.getElementById('startDate').value,
                    endDate: document.getElementById('endDate').value,
                    avatarUrl: document.getElementById('avatarUrl').value.trim()
                };

                const tournamentResult = await apiCall('/tournaments', tournamentPayload, 'POST', true);

                if (!tournamentResult.success) {
                    throw new Error(tournamentResult.message || 'Có lỗi xảy ra khi tạo giải đấu');
                }

                const tournament = tournamentResult.data.tournament;

                // Step 2: Register selected teams as competitors
                if (tournamentData.selectedTeams && tournamentData.selectedTeams.length > 0) {
                    const competitorIds = [];

                    for (const team of tournamentData.selectedTeams) {
                        try {
                            const competitorPayload = {
                                name: team.name,
                                logoUrl: team.logoUrl,
                                description: team.description || '',
                                mail: team.mail || '',
                                tournamentId: tournament._id
                            };

                            const competitorResult = await apiCall('/competitors', competitorPayload, 'POST', true);
                            if (competitorResult.success) {
                                competitorIds.push(competitorResult.data.competitor._id);
                            }
                        } catch (error) {
                            console.error('Error registering team:', team.name, error);
                        }
                    }

                    // Step 3: Generate matches automatically
                    if (competitorIds.length >= 2) {
                        try {
                            await apiCall('/tournaments/generate-matches', {
                                tournamentId: tournament._id,
                                format: tournamentData.format || 'single-elimination',
                                competitorIds: competitorIds
                            }, 'POST', true);
                        } catch (error) {
                            console.error('Error generating matches:', error);
                            // Don't fail the entire process if match generation fails
                        }
                    }
                }

                showSuccess('Giải đấu đã được tạo thành công!');

                // Save the created tournament to localStorage for offline access
                try {
                    // Create full tournament object with all data
                    const fullTournament = {
                        _id: tournament._id,
                        name: tournament.name,
                        gameName: tournament.gameName,
                        description: tournament.description,
                        maxPlayers: tournament.maxPlayers,
                        format: tournament.format,
                        status: tournament.status || 'upcoming',
                        startDate: tournament.startDate,
                        endDate: tournament.endDate,
                        avatarUrl: tournament.avatarUrl,
                        createdAt: tournament.createdAt || new Date().toISOString(),
                        organizerId: tournament.organizerId || 'demo_organizer'
                    };

                    // Save to localStorage for persistence
                    const existingTournaments = JSON.parse(localStorage.getItem('userTournaments') || '[]');
                    const updatedTournaments = [fullTournament, ...existingTournaments.filter(t => t._id !== tournament._id)];
                    localStorage.setItem('userTournaments', JSON.stringify(updatedTournaments));

                    // Also save to sessionStorage for immediate access
                    const newlyCreated = JSON.parse(sessionStorage.getItem('newlyCreatedTournaments') || '[]');
                    newlyCreated.unshift(fullTournament);
                    sessionStorage.setItem('newlyCreatedTournaments', JSON.stringify(newlyCreated));

                    console.log('Tournament saved to local storage:', fullTournament);
                } catch (storageError) {
                    console.warn('Failed to save tournament to storage:', storageError);
                }

                // Clear saved data
                localStorage.removeItem('tournamentCreationData');

                // Redirect after success with refresh parameter
                setTimeout(() => {
                    window.location.href = 'organizer-dashboard.html?refresh=tournaments';
                }, 2000);

            } catch (error) {
                console.error('Error creating tournament:', error);

                // Fallback: Create tournament locally if API fails
                try {
                    const fallbackTournament = {
                        _id: 'local_' + Date.now(),
                        name: tournamentPayload.name,
                        gameName: tournamentPayload.gameName,
                        description: tournamentPayload.description,
                        maxPlayers: tournamentPayload.maxPlayers,
                        format: tournamentPayload.format,
                        status: 'upcoming',
                        startDate: tournamentPayload.startDate,
                        endDate: tournamentPayload.endDate,
                        avatarUrl: tournamentPayload.avatarUrl,
                        createdAt: new Date().toISOString(),
                        organizerId: 'demo_organizer',
                        isLocal: true // Flag to indicate this is a local tournament
                    };

                    // Save to localStorage
                    const existingTournaments = JSON.parse(localStorage.getItem('userTournaments') || '[]');
                    const updatedTournaments = [fallbackTournament, ...existingTournaments];
                    localStorage.setItem('userTournaments', JSON.stringify(updatedTournaments));

                    // Also save to sessionStorage
                    const newlyCreated = JSON.parse(sessionStorage.getItem('newlyCreatedTournaments') || '[]');
                    newlyCreated.unshift(fallbackTournament);
                    sessionStorage.setItem('newlyCreatedTournaments', JSON.stringify(newlyCreated));

                    // Clear creation data
                    localStorage.removeItem('tournamentCreationData');

                    showSuccess('Giải đấu đã được tạo thành công! (Chế độ offline)');

                    setTimeout(() => {
                        window.location.href = 'organizer-dashboard.html?refresh=tournaments';
                    }, 2000);

                } catch (fallbackError) {
                    console.error('Fallback creation failed:', fallbackError);
                    showError('Lỗi khi tạo giải đấu: ' + error.message + '. Vui lòng kiểm tra kết nối và thử lại.');
                }
            } finally {
                showLoading(false);
            }
        }

        function validateForm() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;

            if (!startDate) {
                showError('Vui lòng chọn ngày bắt đầu.');
                return false;
            }

            if (!endDate) {
                showError('Vui lòng chọn ngày kết thúc.');
                return false;
            }

            if (new Date(startDate) >= new Date(endDate)) {
                showError('Ngày kết thúc phải sau ngày bắt đầu.');
                return false;
            }

            if (new Date(startDate) <= new Date()) {
                showError('Ngày bắt đầu phải trong tương lai.');
                return false;
            }

            if (!tournamentData.selectedTeams || tournamentData.selectedTeams.length < 2) {
                showError('Cần ít nhất 2 đội để tạo giải đấu.');
                return false;
            }

            return true;
        }

        function showLoading(show) {
            document.getElementById('loadingMessage').style.display = show ? 'block' : 'none';
            document.getElementById('createTournamentBtn').disabled = show;
        }

        function showSuccess(message) {
            const element = document.getElementById('successMessage');
            element.textContent = message;
            element.style.display = 'block';
            hideError();
        }

        function showError(message) {
            const element = document.getElementById('errorMessage');
            element.textContent = message;
            element.style.display = 'block';
            hideSuccess();
        }

        function hideSuccess() {
            document.getElementById('successMessage').style.display = 'none';
        }

        function hideError() {
            document.getElementById('errorMessage').style.display = 'none';
        }
    </script>
</body>
</html>
